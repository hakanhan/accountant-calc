<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Canada Income Tax Calculator 2026 | Infralix</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }
    
    .header {
      background: linear-gradient(135deg, #f1572b 0%, #d14520 100%);
      color: white;
      padding: 40px 30px;
      text-align: center;
    }
    
    .header h1 {
      font-size: 32px;
      margin-bottom: 10px;
    }
    
    .header p {
      font-size: 16px;
      opacity: 0.9;
    }
    
    .calculator {
      padding: 40px 30px;
    }
    
    .calc-mode {
      display: flex;
      gap: 15px;
      margin-bottom: 30px;
      background: #f8f9fa;
      padding: 10px;
      border-radius: 12px;
    }
    
    .mode-button {
      flex: 1;
      padding: 15px;
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      cursor: pointer;
      text-align: center;
      font-weight: 600;
      transition: all 0.3s;
    }
    
    .mode-button.active {
      background: linear-gradient(135deg, #f1572b 0%, #d14520 100%);
      color: white;
      border-color: #f1572b;
    }
    
    .form-group {
      margin-bottom: 25px;
    }
    
    label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #333;
      font-size: 15px;
    }
    
    select, input {
      width: 100%;
      padding: 12px 15px;
      font-size: 16px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      transition: all 0.3s;
    }
    
    select:focus, input:focus {
      outline: none;
      border-color: #f1572b;
      box-shadow: 0 0 0 3px rgba(241,87,43,0.1);
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
    
    .calc-button {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, #f1572b 0%, #d14520 100%);
      color: white;
      border: none;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      border-radius: 8px;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .calc-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(241,87,43,0.3);
    }
    
    .calc-button:active {
      transform: translateY(0);
    }
    
    .results {
      display: none;
      margin-top: 40px;
      animation: fadeIn 0.5s;
    }
    
    .results.show {
      display: block;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .summary-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      border-radius: 12px;
      margin-bottom: 30px;
    }
    
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .summary-item h3 {
      font-size: 14px;
      opacity: 0.9;
      margin-bottom: 5px;
      font-weight: 500;
    }
    
    .summary-item p {
      font-size: 28px;
      font-weight: 700;
    }
    
    .breakdown {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 25px;
    }
    
    .breakdown h2 {
      font-size: 20px;
      margin-bottom: 20px;
      color: #333;
    }
    
    .breakdown-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .breakdown-table tr {
      border-bottom: 1px solid #e0e0e0;
    }
    
    .breakdown-table tr:last-child {
      border-bottom: none;
    }
    
    .breakdown-table td {
      padding: 12px 0;
      font-size: 15px;
    }
    
    .breakdown-table td:first-child {
      color: #666;
    }
    
    .breakdown-table td:last-child {
      text-align: right;
      font-weight: 600;
      color: #333;
    }
    
    .breakdown-table tr.total td {
      padding-top: 15px;
      font-size: 18px;
      font-weight: 700;
      color: #f1572b;
    }
    
    .breakdown-table tr.net td {
      padding-top: 15px;
      font-size: 20px;
      font-weight: 700;
      color: #4CAF50;
    }
    
    .chart-container {
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 25px;
    }
    
    .chart-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 20px;
      color: #333;
      text-align: center;
    }
    
    .chart-wrapper {
      position: relative;
      height: 300px;
    }
    
    .monthly-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    
    .monthly-table th {
      background: #f1572b;
      color: white;
      padding: 12px;
      text-align: left;
      font-weight: 600;
    }
    
    .monthly-table td {
      padding: 12px;
      border-bottom: 1px solid #e0e0e0;
    }
    
    .monthly-table tr:nth-child(even) {
      background: #f8f9fa;
    }
    
    .monthly-table tr:last-child td {
      font-weight: 700;
      background: #fff3e0;
      color: #f1572b;
    }
    
    .pay-frequency-info {
      background: #e3f2fd;
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
      font-size: 14px;
      color: #1976d2;
    }
    
    .cta-box {
      background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
      padding: 25px;
      border-radius: 12px;
      margin-top: 30px;
    }
    
    .cta-box h3 {
      font-size: 20px;
      margin-bottom: 10px;
      color: #333;
    }
    
    .cta-box p {
      color: #666;
      margin-bottom: 15px;
      line-height: 1.6;
    }
    
    .cta-button {
      display: inline-block;
      padding: 12px 30px;
      background: #f1572b;
      color: white;
      text-decoration: none;
      border-radius: 8px;
      font-weight: 600;
      transition: all 0.3s;
    }
    
    .cta-button:hover {
      background: #d14520;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(241,87,43,0.3);
    }
    
    .disclaimer {
      margin-top: 30px;
      padding: 20px;
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      border-radius: 8px;
      font-size: 13px;
      color: #856404;
      line-height: 1.6;
    }
    
    @media (max-width: 768px) {
      .summary-grid {
        grid-template-columns: 1fr;
      }
      
      .form-row {
        grid-template-columns: 1fr;
      }
      
      .calc-mode {
        flex-direction: column;
      }
      
      .header h1 {
        font-size: 24px;
      }
      
      .calculator {
        padding: 30px 20px;
      }
      
      .chart-wrapper {
        height: 250px;
      }
    }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>üá®üá¶ Canada Income Tax Calculator 2026</h1>
    <p>Complete tax calculation with CPP, EI, charts & monthly breakdown</p>
    <p style="font-size: 14px; margin-top: 10px; opacity: 0.8;">Free Professional Tool by <strong>Infralix</strong></p>
  </div>
  
  <div class="calculator">
    <!-- Calculation Mode -->
    <div class="calc-mode">
      <div class="mode-button active" onclick="setMode('gross')">
        üìä Annual Salary
      </div>
      <div class="mode-button" onclick="setMode('hourly')">
        ‚è∞ Hourly Rate
      </div>
      <div class="mode-button" onclick="setMode('net')">
        üí∞ Net to Gross
      </div>
    </div>
    
    <div class="form-row">
      <div class="form-group">
        <label for="province">Province / Territory:</label>
        <select id="province">
          <option value="ON">Ontario</option>
          <option value="BC">British Columbia</option>
          <option value="AB">Alberta</option>
          <option value="QC">Quebec (Estimate)</option>
          <option value="NS">Nova Scotia</option>
          <option value="NB">New Brunswick</option>
          <option value="MB">Manitoba</option>
          <option value="SK">Saskatchewan</option>
          <option value="PE">Prince Edward Island</option>
          <option value="NL">Newfoundland & Labrador</option>
          <option value="YT">Yukon</option>
          <option value="NT">Northwest Territories</option>
          <option value="NU">Nunavut</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="payFrequency">Pay Frequency:</label>
        <select id="payFrequency">
          <option value="annual">Annual</option>
          <option value="monthly">Monthly</option>
          <option value="biweekly">Bi-weekly (26 pays)</option>
          <option value="weekly">Weekly (52 pays)</option>
        </select>
      </div>
    </div>
    
    <!-- Hourly Rate Fields (hidden by default) -->
    <div id="hourly-fields" style="display: none;">
      <div class="form-row">
        <div class="form-group">
          <label for="hourlyRate">Hourly Rate:</label>
          <input type="number" id="hourlyRate" placeholder="70.00" min="0" step="0.25" value="70">
        </div>
        
        <div class="form-group">
          <label for="hoursPerWeek">Hours per Week:</label>
          <select id="hoursPerWeek">
            <option value="40">40 hours (Full-time)</option>
            <option value="37.5">37.5 hours (Standard)</option>
            <option value="35">35 hours</option>
            <option value="30">30 hours (Part-time)</option>
            <option value="20">20 hours (Part-time)</option>
            <option value="custom">Custom</option>
          </select>
          <input type="number" id="customHours" placeholder="40" min="1" max="80" step="0.5" style="display:none; margin-top: 10px;">
        </div>
      </div>
      
      <div class="form-group">
        <label for="weeksPerYear">Paid Weeks per Year:</label>
        <select id="weeksPerYear">
          <option value="52">52 weeks (No vacation)</option>
          <option value="50">50 weeks (2 weeks vacation)</option>
          <option value="48">48 weeks (4 weeks vacation)</option>
          <option value="46">46 weeks (6 weeks vacation)</option>
          <option value="custom">Custom</option>
        </select>
        <input type="number" id="customWeeks" placeholder="52" min="1" max="52" step="1" style="display:none; margin-top: 10px;">
      </div>
      
      <div class="pay-frequency-info" style="margin-bottom: 20px;">
        üí° <strong>Your estimated annual salary:</strong> 
        <span id="estimated-salary" style="color: #f1572b; font-weight: 700; font-size: 18px;">$145,600</span>
      </div>
    </div>
    
    <!-- Annual Salary Field -->
    <div id="annual-field">
      <div class="form-group">
        <label for="income" id="incomeLabel">Gross Annual Income (before tax):</label>
        <input type="number" id="income" placeholder="75000" min="0" step="100" value="75000">
      </div>
    </div>
    
    <button class="calc-button" onclick="calculateTax()">
      <span id="buttonText">Calculate My Taxes üìä</span>
    </button>
    
    <div id="results" class="results">
      <!-- Summary Card -->
      <div class="summary-card">
        <h2 style="font-size: 24px; margin-bottom: 10px;">Your Tax Summary</h2>
        <div class="summary-grid">
          <div class="summary-item">
            <h3>Gross Annual</h3>
            <p id="summary-gross">$75,000</p>
          </div>
          <div class="summary-item">
            <h3>Net Annual</h3>
            <p id="summary-net">$54,386</p>
          </div>
          <div class="summary-item">
            <h3>Per Month</h3>
            <p id="summary-monthly">$4,532</p>
          </div>
          <div class="summary-item">
            <h3>Effective Rate</h3>
            <p id="summary-rate">27.5%</p>
          </div>
        </div>
      </div>
      
      <!-- Pay Frequency Breakdown -->
      <div class="breakdown">
        <h2>üíµ Your Take-Home Pay</h2>
        <table class="breakdown-table">
          <tr id="hourly-breakdown-row" style="display:none;">
            <td>Per Hour (Net)</td>
            <td id="pay-hourly-net">$50.25</td>
          </tr>
          <tr>
            <td>Per Year (Annual)</td>
            <td id="pay-annual">$54,386</td>
          </tr>
          <tr>
            <td>Per Month (Monthly)</td>
            <td id="pay-monthly">$4,532</td>
          </tr>
          <tr>
            <td>Per Pay (Bi-weekly, 26 pays)</td>
            <td id="pay-biweekly">$2,092</td>
          </tr>
          <tr>
            <td>Per Week (Weekly, 52 pays)</td>
            <td id="pay-weekly">$1,046</td>
          </tr>
        </table>
        <div class="pay-frequency-info">
          ‚ÑπÔ∏è <strong>Note:</strong> In Canada, payroll deductions are calculated on an annualized basis. 
          Your net pay per period remains <strong>consistent throughout the year</strong> (unlike some countries 
          where it decreases as cumulative tax increases).
        </div>
      </div>
      
      <!-- Detailed Breakdown -->
      <div class="breakdown">
        <h2>üí∞ Annual Withholding Breakdown</h2>
        <table class="breakdown-table">
          <tr>
            <td>Gross Annual Income</td>
            <td id="detail-gross">$75,000</td>
          </tr>
          <tr>
            <td>CPP Contribution (5.95%)</td>
            <td id="detail-cpp">-$4,231</td>
          </tr>
          <tr id="cpp2-row" style="display:none;">
            <td>CPP2 Contribution (4.00%)</td>
            <td id="detail-cpp2">-$416</td>
          </tr>
          <tr>
            <td>EI Premium (1.63%)</td>
            <td id="detail-ei">-$1,123</td>
          </tr>
          <tr>
            <td>Federal Income Tax</td>
            <td id="detail-federal">-$11,753</td>
          </tr>
          <tr>
            <td>Provincial Income Tax</td>
            <td id="detail-provincial">-$5,493</td>
          </tr>
          <tr class="total">
            <td>Total Annual Deductions</td>
            <td id="detail-total">-$22,600</td>
          </tr>
          <tr class="net">
            <td>Net Annual Income</td>
            <td id="detail-net">$52,400</td>
          </tr>
        </table>
      </div>
      
      <!-- Monthly Breakdown Table -->
      <div class="breakdown">
        <h2>üìÖ Monthly Breakdown (Consistent Year-Round)</h2>
        <table class="monthly-table">
          <thead>
            <tr>
              <th>Month</th>
              <th>Gross</th>
              <th>Deductions</th>
              <th>Net Pay</th>
            </tr>
          </thead>
          <tbody id="monthly-tbody">
            <!-- Populated by JS -->
          </tbody>
        </table>
      </div>
      
      <!-- Pie Charts -->
      <div class="chart-container">
        <div class="chart-title">üìä Income Distribution</div>
        <div class="chart-wrapper">
          <canvas id="incomeChart"></canvas>
        </div>
      </div>
      
      <div class="chart-container">
        <div class="chart-title">ü•ß Tax Breakdown by Component</div>
        <div class="chart-wrapper">
          <canvas id="taxChart"></canvas>
        </div>
      </div>
      
      <!-- Employer Contribution -->
      <div class="breakdown">
        <h2>üí° Employer Contributions (Hidden Costs)</h2>
        <table class="breakdown-table">
          <tr>
            <td>Employer CPP Contribution</td>
            <td id="employer-cpp">$4,231</td>
          </tr>
          <tr id="employer-cpp2-row" style="display:none;">
            <td>Employer CPP2 Contribution</td>
            <td id="employer-cpp2">$416</td>
          </tr>
          <tr>
            <td>Employer EI Premium (1.4x)</td>
            <td id="employer-ei">$1,572</td>
          </tr>
          <tr class="total">
            <td><strong>Total Employer Cost</strong></td>
            <td id="employer-total">$5,803</td>
          </tr>
        </table>
        <p style="margin-top: 15px; color: #666; font-size: 14px;">
          Your employer pays an additional <span id="employer-summary" style="color: #f1572b; font-weight: 600;">$5,803</span> 
          on top of your salary. Your <strong>true cost to company</strong> is 
          <span id="total-cost" style="color: #f1572b; font-weight: 600;">$80,803</span>!
        </p>
      </div>
      
      <!-- CTA -->
      <div class="cta-box">
        <h3>üíº Need Business Tax Help?</h3>
        <p>
          Infralix Invoice Manager helps Canadian small businesses track income, expenses, 
          calculate HST/GST, and prepare tax documents for CRA filing. Save time and stay compliant.
        </p>
        <a href="https://infralix.com/signup" class="cta-button">Try Infralix Free ‚Üí</a>
      </div>
    </div>
    
    <!-- Disclaimer -->
    <div class="disclaimer">
      ‚ö†Ô∏è <strong>Disclaimer:</strong> This calculator provides estimates based on 2026 CRA tax brackets, 
      CPP/EI rates, and basic personal amounts. Actual taxes may vary based on deductions, credits, 
      and individual circumstances. This is not professional tax advice. Consult a tax professional or accountant 
      for personalized guidance.
    </div>
  </div>
</div>

<script>
// ============================================================================
// GLOBAL STATE
// ============================================================================
let calculationMode = 'gross'; // 'gross' or 'net'
let incomeChart = null;
let taxChart = null;

// ============================================================================
// 2026 CANADA TAX DATA
// ============================================================================

const federalBrackets2026 = [
  { limit: 58523, rate: 0.14 },
  { limit: 117045, rate: 0.205 },
  { limit: 181440, rate: 0.26 },
  { limit: 258482, rate: 0.29 },
  { limit: Infinity, rate: 0.33 }
];

const provincialBrackets2026 = {
  ON: [
    { limit: 52417, rate: 0.0505 },
    { limit: 104835, rate: 0.0915 },
    { limit: 150000, rate: 0.1116 },
    { limit: 220000, rate: 0.1216 },
    { limit: Infinity, rate: 0.1316 }
  ],
  BC: [
    { limit: 48908, rate: 0.0506 },
    { limit: 97816, rate: 0.077 },
    { limit: 112365, rate: 0.105 },
    { limit: 136405, rate: 0.1229 },
    { limit: 184857, rate: 0.147 },
    { limit: 268218, rate: 0.168 },
    { limit: Infinity, rate: 0.205 }
  ],
  AB: [
    { limit: 151364, rate: 0.10 },
    { limit: 181637, rate: 0.12 },
    { limit: 242183, rate: 0.13 },
    { limit: 363272, rate: 0.14 },
    { limit: Infinity, rate: 0.15 }
  ],
  QC: [
    { limit: 52885, rate: 0.14 },
    { limit: 105770, rate: 0.19 },
    { limit: 128580, rate: 0.24 },
    { limit: Infinity, rate: 0.2575 }
  ],
  NS: [
    { limit: 30000, rate: 0.0879 },
    { limit: 60000, rate: 0.1495 },
    { limit: 93000, rate: 0.1667 },
    { limit: 150000, rate: 0.175 },
    { limit: Infinity, rate: 0.21 }
  ],
  NB: [
    { limit: 51017, rate: 0.094 },
    { limit: 102034, rate: 0.14 },
    { limit: 176756, rate: 0.16 },
    { limit: Infinity, rate: 0.195 }
  ],
  MB: [
    { limit: 47000, rate: 0.108 },
    { limit: 100000, rate: 0.1275 },
    { limit: Infinity, rate: 0.174 }
  ],
  SK: [
    { limit: 52635, rate: 0.105 },
    { limit: 150432, rate: 0.125 },
    { limit: Infinity, rate: 0.145 }
  ],
  PE: [
    { limit: 32656, rate: 0.098 },
    { limit: 64313, rate: 0.138 },
    { limit: Infinity, rate: 0.167 }
  ],
  NL: [
    { limit: 43198, rate: 0.087 },
    { limit: 86395, rate: 0.145 },
    { limit: 154244, rate: 0.158 },
    { limit: 215943, rate: 0.173 },
    { limit: Infinity, rate: 0.208 }
  ],
  YT: [
    { limit: 58523, rate: 0.064 },
    { limit: 117045, rate: 0.09 },
    { limit: 181440, rate: 0.109 },
    { limit: 578973, rate: 0.128 },
    { limit: Infinity, rate: 0.15 }
  ],
  NT: [
    { limit: 52096, rate: 0.059 },
    { limit: 104192, rate: 0.086 },
    { limit: 169743, rate: 0.122 },
    { limit: Infinity, rate: 0.1405 }
  ],
  NU: [
    { limit: 54361, rate: 0.04 },
    { limit: 108722, rate: 0.07 },
    { limit: 176667, rate: 0.09 },
    { limit: Infinity, rate: 0.115 }
  ]
};

const basicPersonalAmounts2026 = {
  federal: 16452,
  ON: 12989, BC: 13141, AB: 22024, QC: 19001, NS: 9456,
  NB: 13005, MB: 11141, SK: 18905, PE: 13500, NL: 10818,
  YT: 16452, NT: 17181, NU: 19210
};

const cpp2026 = {
  exemption: 3500,
  rate: 0.0595,
  maxEarnings: 74600,
  maxContribution: 4230.45
};

const cpp2_2026 = {
  rate: 0.04,
  minEarnings: 74600,
  maxEarnings: 85000,
  maxContribution: 416.00
};

const ei2026 = {
  rate: 0.0163,
  maxEarnings: 68900,
  maxPremium: 1123.07,
  employerRate: 1.4
};

// ============================================================================
// MODE SWITCHING
// ============================================================================

function setMode(mode) {
  calculationMode = mode;
  document.querySelectorAll('.mode-button').forEach(btn => {
    btn.classList.remove('active');
  });
  event.target.classList.add('active');
  
  const hourlyFields = document.getElementById('hourly-fields');
  const annualField = document.getElementById('annual-field');
  
  if (mode === 'gross') {
    hourlyFields.style.display = 'none';
    annualField.style.display = 'block';
    document.getElementById('incomeLabel').textContent = 'Gross Annual Income (before tax):';
    document.getElementById('buttonText').textContent = 'Calculate My Taxes üìä';
  } else if (mode === 'hourly') {
    hourlyFields.style.display = 'block';
    annualField.style.display = 'none';
    document.getElementById('buttonText').textContent = 'Calculate from Hourly Rate ‚è∞';
    updateEstimatedSalary();
  } else { // net
    hourlyFields.style.display = 'none';
    annualField.style.display = 'block';
    document.getElementById('incomeLabel').textContent = 'Desired Net Annual Income (after tax):';
    document.getElementById('buttonText').textContent = 'Calculate Required Gross üí∞';
  }
}

function updateEstimatedSalary() {
  const hourlyRate = parseFloat(document.getElementById('hourlyRate').value) || 0;
  let hoursPerWeek = parseFloat(document.getElementById('hoursPerWeek').value);
  if (document.getElementById('hoursPerWeek').value === 'custom') {
    hoursPerWeek = parseFloat(document.getElementById('customHours').value) || 40;
  }
  
  let weeksPerYear = parseFloat(document.getElementById('weeksPerYear').value);
  if (document.getElementById('weeksPerYear').value === 'custom') {
    weeksPerYear = parseFloat(document.getElementById('customWeeks').value) || 52;
  }
  
  const annualSalary = hourlyRate * hoursPerWeek * weeksPerYear;
  document.getElementById('estimated-salary').textContent = formatCurrency(annualSalary);
}

// Add event listeners for hourly inputs
document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('hourlyRate').addEventListener('input', updateEstimatedSalary);
  document.getElementById('hoursPerWeek').addEventListener('change', function() {
    if (this.value === 'custom') {
      document.getElementById('customHours').style.display = 'block';
    } else {
      document.getElementById('customHours').style.display = 'none';
    }
    updateEstimatedSalary();
  });
  document.getElementById('customHours').addEventListener('input', updateEstimatedSalary);
  document.getElementById('weeksPerYear').addEventListener('change', function() {
    if (this.value === 'custom') {
      document.getElementById('customWeeks').style.display = 'block';
    } else {
      document.getElementById('customWeeks').style.display = 'none';
    }
    updateEstimatedSalary();
  });
  document.getElementById('customWeeks').addEventListener('input', updateEstimatedSalary);
});

// ============================================================================
// TAX CALCULATION
// ============================================================================

function calculateBracketTax(income, brackets) {
  let tax = 0;
  let previousLimit = 0;
  
  for (let bracket of brackets) {
    if (income > previousLimit) {
      const taxableInBracket = Math.min(income - previousLimit, bracket.limit - previousLimit);
      tax += taxableInBracket * bracket.rate;
      previousLimit = bracket.limit;
    } else {
      break;
    }
  }
  
  return tax;
}

function calculateGrossToNet(grossIncome, province) {
  // CPP
  let cpp = 0;
  if (grossIncome > cpp2026.exemption) {
    const pensionableEarnings = Math.min(grossIncome, cpp2026.maxEarnings) - cpp2026.exemption;
    cpp = Math.min(pensionableEarnings * cpp2026.rate, cpp2026.maxContribution);
  }
  
  // CPP2
  let cpp2 = 0;
  if (grossIncome > cpp2_2026.minEarnings) {
    const cpp2Earnings = Math.min(grossIncome, cpp2_2026.maxEarnings) - cpp2_2026.minEarnings;
    cpp2 = Math.min(cpp2Earnings * cpp2_2026.rate, cpp2_2026.maxContribution);
  }
  
  // EI
  const ei = Math.min(grossIncome * ei2026.rate, ei2026.maxPremium);
  
  // Federal Tax
  const federalTax = calculateBracketTax(grossIncome, federalBrackets2026);
  const federalBasicCredit = basicPersonalAmounts2026.federal * 0.14;
  const federalTaxFinal = Math.max(0, federalTax - federalBasicCredit);
  
  // Provincial Tax
  const provBrackets = provincialBrackets2026[province] || provincialBrackets2026.ON;
  const provincialTax = calculateBracketTax(grossIncome, provBrackets);
  const provincialBPA = basicPersonalAmounts2026[province] || basicPersonalAmounts2026.ON;
  const provincialRate = provBrackets[0].rate;
  const provincialBasicCredit = provincialBPA * provincialRate;
  const provincialTaxFinal = Math.max(0, provincialTax - provincialBasicCredit);
  
  const totalDeductions = cpp + cpp2 + ei + federalTaxFinal + provincialTaxFinal;
  const netIncome = grossIncome - totalDeductions;
  
  return {
    gross: grossIncome,
    net: netIncome,
    cpp, cpp2, ei,
    federalTax: federalTaxFinal,
    provincialTax: provincialTaxFinal,
    totalDeductions
  };
}

function calculateNetToGross(targetNet, province) {
  // Binary search for gross income
  let low = targetNet;
  let high = targetNet * 2;
  let iterations = 0;
  const maxIterations = 50;
  const tolerance = 1;
  
  while (iterations < maxIterations) {
    const mid = (low + high) / 2;
    const result = calculateGrossToNet(mid, province);
    
    if (Math.abs(result.net - targetNet) < tolerance) {
      return result;
    }
    
    if (result.net < targetNet) {
      low = mid;
    } else {
      high = mid;
    }
    
    iterations++;
  }
  
  // Return best approximation
  return calculateGrossToNet((low + high) / 2, province);
}

// ============================================================================
// MAIN CALCULATION
// ============================================================================

function calculateTax() {
  let annualInput;
  const province = document.getElementById('province').value;
  const payFrequency = document.getElementById('payFrequency').value;
  
  if (calculationMode === 'hourly') {
    // Calculate from hourly rate
    const hourlyRate = parseFloat(document.getElementById('hourlyRate').value);
    let hoursPerWeek = parseFloat(document.getElementById('hoursPerWeek').value);
    if (document.getElementById('hoursPerWeek').value === 'custom') {
      hoursPerWeek = parseFloat(document.getElementById('customHours').value) || 40;
    }
    
    let weeksPerYear = parseFloat(document.getElementById('weeksPerYear').value);
    if (document.getElementById('weeksPerYear').value === 'custom') {
      weeksPerYear = parseFloat(document.getElementById('customWeeks').value) || 52;
    }
    
    if (!hourlyRate || hourlyRate <= 0) {
      alert('Please enter a valid hourly rate');
      return;
    }
    
    annualInput = hourlyRate * hoursPerWeek * weeksPerYear;
  } else {
    // Annual or net mode
    const inputValue = parseFloat(document.getElementById('income').value);
    
    if (!inputValue || inputValue <= 0) {
      alert('Please enter a valid amount');
      return;
    }
    
    // Convert to annual if needed
    annualInput = inputValue;
    if (payFrequency === 'monthly') {
      annualInput = inputValue * 12;
    } else if (payFrequency === 'biweekly') {
      annualInput = inputValue * 26;
    } else if (payFrequency === 'weekly') {
      annualInput = inputValue * 52;
    }
  }
  
  // Calculate
  let result;
  if (calculationMode === 'net') {
    result = calculateNetToGross(annualInput, province);
  } else {
    // Both 'gross' and 'hourly' modes calculate gross to net
    result = calculateGrossToNet(annualInput, province);
  }
  
  // Employer contributions
  const employerCPP = result.cpp;
  const employerCPP2 = result.cpp2;
  const employerEI = result.ei * ei2026.employerRate;
  const totalEmployerCost = employerCPP + employerCPP2 + employerEI;
  const totalCostToCompany = result.gross + totalEmployerCost;
  
  // Pay frequency calculations
  const netMonthly = result.net / 12;
  const netBiweekly = result.net / 26;
  const netWeekly = result.net / 52;
  
  const grossMonthly = result.gross / 12;
  const deductionsMonthly = result.totalDeductions / 12;
  
  // Hourly calculations if in hourly mode
  if (calculationMode === 'hourly') {
    let hoursPerWeek = parseFloat(document.getElementById('hoursPerWeek').value);
    if (document.getElementById('hoursPerWeek').value === 'custom') {
      hoursPerWeek = parseFloat(document.getElementById('customHours').value) || 40;
    }
    
    let weeksPerYear = parseFloat(document.getElementById('weeksPerYear').value);
    if (document.getElementById('weeksPerYear').value === 'custom') {
      weeksPerYear = parseFloat(document.getElementById('customWeeks').value) || 52;
    }
    
    const totalHoursPerYear = hoursPerWeek * weeksPerYear;
    const netHourlyRate = result.net / totalHoursPerYear;
    
    document.getElementById('hourly-breakdown-row').style.display = 'table-row';
    document.getElementById('pay-hourly-net').textContent = formatCurrency(netHourlyRate) + '/hour';
  } else {
    document.getElementById('hourly-breakdown-row').style.display = 'none';
  }
  
  // Update Summary
  document.getElementById('summary-gross').textContent = formatCurrency(result.gross);
  document.getElementById('summary-net').textContent = formatCurrency(result.net);
  document.getElementById('summary-monthly').textContent = formatCurrency(netMonthly);
  const effectiveRate = (result.totalDeductions / result.gross * 100).toFixed(1);
  document.getElementById('summary-rate').textContent = effectiveRate + '%';
  
  // Update Pay Frequency
  document.getElementById('pay-annual').textContent = formatCurrency(result.net);
  document.getElementById('pay-monthly').textContent = formatCurrency(netMonthly);
  document.getElementById('pay-biweekly').textContent = formatCurrency(netBiweekly);
  document.getElementById('pay-weekly').textContent = formatCurrency(netWeekly);
  
  // Update Detailed Breakdown
  document.getElementById('detail-gross').textContent = formatCurrency(result.gross);
  document.getElementById('detail-cpp').textContent = '-' + formatCurrency(result.cpp);
  document.getElementById('detail-cpp2').textContent = '-' + formatCurrency(result.cpp2);
  document.getElementById('detail-ei').textContent = '-' + formatCurrency(result.ei);
  document.getElementById('detail-federal').textContent = '-' + formatCurrency(result.federalTax);
  document.getElementById('detail-provincial').textContent = '-' + formatCurrency(result.provincialTax);
  document.getElementById('detail-total').textContent = '-' + formatCurrency(result.totalDeductions);
  document.getElementById('detail-net').textContent = formatCurrency(result.net);
  
  // Show/hide CPP2
  if (result.cpp2 > 0) {
    document.getElementById('cpp2-row').style.display = 'table-row';
    document.getElementById('employer-cpp2-row').style.display = 'table-row';
  } else {
    document.getElementById('cpp2-row').style.display = 'none';
    document.getElementById('employer-cpp2-row').style.display = 'none';
  }
  
  // Update Employer Contributions
  document.getElementById('employer-cpp').textContent = formatCurrency(employerCPP);
  document.getElementById('employer-cpp2').textContent = formatCurrency(employerCPP2);
  document.getElementById('employer-ei').textContent = formatCurrency(employerEI);
  document.getElementById('employer-total').textContent = formatCurrency(totalEmployerCost);
  document.getElementById('employer-summary').textContent = formatCurrency(totalEmployerCost);
  document.getElementById('total-cost').textContent = formatCurrency(totalCostToCompany);
  
  // Update Monthly Table
  updateMonthlyTable(grossMonthly, deductionsMonthly, netMonthly);
  
  // Update Charts
  updateCharts(result);
  
  // Show Results
  document.getElementById('results').classList.add('show');
  document.getElementById('results').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// ============================================================================
// MONTHLY TABLE
// ============================================================================

function updateMonthlyTable(gross, deductions, net) {
  const months = [
    'January', 'February', 'March', 'April', 'May', 'June',
    'July', 'August', 'September', 'October', 'November', 'December'
  ];
  
  const tbody = document.getElementById('monthly-tbody');
  tbody.innerHTML = '';
  
  months.forEach(month => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${month}</td>
      <td>${formatCurrency(gross)}</td>
      <td>-${formatCurrency(deductions)}</td>
      <td><strong>${formatCurrency(net)}</strong></td>
    `;
    tbody.appendChild(tr);
  });
  
  // Total row
  const totalTr = document.createElement('tr');
  totalTr.innerHTML = `
    <td><strong>ANNUAL TOTAL</strong></td>
    <td><strong>${formatCurrency(gross * 12)}</strong></td>
    <td><strong>-${formatCurrency(deductions * 12)}</strong></td>
    <td><strong>${formatCurrency(net * 12)}</strong></td>
  `;
  tbody.appendChild(totalTr);
}

// ============================================================================
// CHARTS
// ============================================================================

function updateCharts(result) {
  // Destroy existing charts
  if (incomeChart) incomeChart.destroy();
  if (taxChart) taxChart.destroy();
  
  // Income Distribution Chart
  const incomeCtx = document.getElementById('incomeChart').getContext('2d');
  incomeChart = new Chart(incomeCtx, {
    type: 'pie',
    data: {
      labels: ['Net Income', 'Total Deductions'],
      datasets: [{
        data: [result.net, result.totalDeductions],
        backgroundColor: ['#4CAF50', '#f1572b'],
        borderWidth: 2,
        borderColor: '#fff'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom'
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              const label = context.label || '';
              const value = formatCurrency(context.parsed);
              const percent = ((context.parsed / result.gross) * 100).toFixed(1);
              return `${label}: ${value} (${percent}%)`;
            }
          }
        }
      }
    }
  });
  
  // Tax Breakdown Chart
  const taxCtx = document.getElementById('taxChart').getContext('2d');
  const taxData = {
    labels: ['CPP', 'EI', 'Federal Tax', 'Provincial Tax'],
    values: [result.cpp, result.ei, result.federalTax, result.provincialTax]
  };
  
  if (result.cpp2 > 0) {
    taxData.labels.splice(1, 0, 'CPP2');
    taxData.values.splice(1, 0, result.cpp2);
  }
  
  taxChart = new Chart(taxCtx, {
    type: 'pie',
    data: {
      labels: taxData.labels,
      datasets: [{
        data: taxData.values,
        backgroundColor: [
          '#667eea',
          '#764ba2',
          '#f1572b',
          '#d14520',
          '#ff6b6b'
        ],
        borderWidth: 2,
        borderColor: '#fff'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom'
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              const label = context.label || '';
              const value = formatCurrency(context.parsed);
              const percent = ((context.parsed / result.totalDeductions) * 100).toFixed(1);
              return `${label}: ${value} (${percent}%)`;
            }
          }
        }
      }
    }
  });
}

// ============================================================================
// UTILS
// ============================================================================

function formatCurrency(amount) {
  return '$' + Math.round(amount).toLocaleString('en-CA');
}

// Auto-calculate on page load
window.addEventListener('load', () => {
  calculateTax();
});
</script>

</body>
</html>
